# 错误处理与断点续传指南

本文档介绍如何使用系统的错误处理和断点恢复功能。

## 🎯 功能概述

当代码执行出错时，系统会自动：
1. 捕获错误并显示详细信息
2. 询问处理方式（自动修复/手动修复/跳过）
3. 支持保存状态并从断点恢复

---

## 📋 错误处理流程

### 自动处理策略

系统默认采用智能处理策略：

```
执行出错 → [重试次数 < 3] → 自动修复并重试
           [重试次数 >= 3] → 跳过本轮，继续下一轮
```

### 三种处理模式

#### 1. 自动修复 (Auto Fix)
- **触发条件**: 错误重试次数 < 3
- **工作原理**: LLM 分析错误并自动修改代码
- **优点**: 无需人工干预，自动解决常见错误
- **示例错误**:
  - 缺少导入: `NameError: name 'np' is not defined` ✅ 已修复
  - 语法错误
  - 变量未定义

#### 2. 手动修复 (Manual Fix)
- **触发条件**: 需要用户设置 (暂未在CLI中实现交互选择)
- **工作原理**: 保存当前状态，等待用户修复代码
- **适用场景**: 复杂的业务逻辑错误

#### 3. 跳过本轮 (Skip)
- **触发条件**: 自动修复失败或超过重试次数
- **工作原理**: 记录失败，继续下一轮分析
- **适用场景**: 当前任务不重要或数据不支持

---

## 🔧 使用示例

### 正常运行分析

```python
from app.graphs.code_analysis_graph import run_analysis

result = run_analysis("./data/raw/test_data.csv")
```

**输出示例**:
```
================================================================================
开始多轮迭代数据分析工作流
================================================================================
CSV 文件: ./data/raw/test_data.csv
================================================================================

============================================================
节点 1: 读取 CSV 文件信息
============================================================
✓ 成功读取 CSV 文件: ./data/raw/test_data.csv
  - 行数: 25
  - 列数: 7

...

============================================================
节点 3: 执行第 4 轮代码
============================================================
✗ 代码执行失败
错误: NameError: name 'np' is not defined

================================================================================
节点 3.5: 处理执行错误
================================================================================

❌ 第 4 轮分析执行失败
任务: 异常值检测：识别年龄或分数中的异常数据点

>>> 自动选择：尝试自动修复（第 1/3 次重试）

正在调用 LLM 分析并修复代码...
✓ 代码修复成功: 移除了 import numpy as np，直接使用预定义的 np 变量

修复后的代码:
--------------------------------------------------------------------------------
# 读取数据
df = pd.read_csv(csv_path)

# 使用IQR方法检测异常值（使用预定义的np）
...
```

### 断点恢复分析

如果分析过程中暂停（如手动修复模式），可以恢复：

```python
from app.graphs.code_analysis_graph import resume_analysis

# 方式1：不提供修复代码，从当前状态继续
result = resume_analysis(
    state_file="./analysis_state_test_data_20251029_162830.json"
)

# 方式2：提供修复后的代码
fixed_code = """
import pandas as pd

df = pd.read_csv(csv_path)
# ... 您修复后的代码
"""

result = resume_analysis(
    state_file="./analysis_state_test_data_20251029_162830.json",
    fixed_code=fixed_code
)
```

---

## 🛠️ 关键修复

### 已解决的导入问题

**问题**: 生成的代码包含 `import numpy as np`，但执行环境没有提供

**解决方案**:
- ✅ 在 `code_executor.py` 中预先导入 pandas 和 numpy
- ✅ 在 `safe_globals` 中提供 `pd` 和 `np` 变量
- ✅ LLM 生成代码时提示可以直接使用 `pd` 和 `np`

```python
# app/utils/code_executor.py (已修复)
safe_globals = {
    "__builtins__": __builtins__,
    "csv_path": csv_path,
    "pd": pd,        # pandas 已预定义
    "np": np,        # numpy 已预定义
}
```

---

## 📊 状态文件格式

保存的状态文件是 JSON 格式，包含：

```json
{
  "csv_path": "./data/raw/test_data.csv",
  "current_round": 4,
  "analysis_plan": [
    "基础统计分析",
    "数据分布分析",
    "相关性分析",
    "异常值检测"
  ],
  "completed_analyses": [
    "基础统计分析",
    "数据分布分析",
    "相关性分析"
  ],
  "analysis_rounds": [...],
  "generated_code": "...",
  "error": "NameError: name 'np' is not defined",
  "temp_report_path": "./analysis_temp_test_data_20251029_162830.md",
  "saved_at": "2025-10-29 16:29:20"
}
```

---

## 🚀 工作流程图

```
┌──────────────┐
│ 读取CSV信息  │
└──────┬───────┘
       │
┌──────▼───────┐
│  规划分析    │
└──────┬───────┘
       │
       ▼
    ┌─────────────────┐
    │   生成代码      │
    └────────┬────────┘
             │
    ┌────────▼────────┐
    │   执行代码      │
    └────┬────┬───────┘
         │    │
    成功 │    │ 失败
         │    │
         │    ▼
         │ ┌──────────────┐
         │ │ 处理错误     │
         │ └──┬───┬───┬───┘
         │    │   │   │
         │ 自动│手动│跳过
         │ 修复│修复│
         │    │   │   │
         │    └───┘   │
         │      │     │
         │     重试   │
         │            │
    ┌────▼────────────▼─┐
    │  更新临时报告     │
    └────────┬──────────┘
             │
    ┌────────▼──────────┐
    │  决策是否继续     │
    └────┬────┬─────────┘
         │    │
    继续 │    │ 结束
         │    │
         └────┘
              │
    ┌─────────▼─────────┐
    │  生成最终报告     │
    └───────────────────┘
```

---

## ⚙️ 配置选项

### 最大重试次数

在 `handle_error_node` 中修改：

```python
MAX_RETRY = 3  # 默认最多自动重试3次
```

### 最大分析轮次

在 `decide_continue_node` 中修改：

```python
MAX_ROUNDS = 5  # 默认最多5轮分析
```

---

## 📝 注意事项

1. **状态文件保存**: 自动保存在当前工作目录
2. **临时报告**: 实时更新，可随时查看分析进度
3. **最终报告**: 所有轮次完成后生成综合报告
4. **错误日志**: 记录在 `messages` 字段和临时报告中

---

## 🎓 最佳实践

1. **首次运行**: 使用 `run_analysis()` 启动新的分析
2. **监控进度**: 查看临时报告文件了解实时进度
3. **错误处理**: 信任自动修复机制（已优化）
4. **断点恢复**: 保留状态文件以便需要时恢复

---

生成时间: 2025-10-29
版本: 2.0 (支持错误处理与断点续传)
